server {
    listen 80;
    server_name localhost;

    # Page de validation pour magic links (version locale)
    location /validate {
        add_header Content-Type text/html;
        return 200 '<!DOCTYPE html><html><head><title>Validation d\'acc√®s - IAmetube</title><meta charset="utf-8"><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;text-align:center;padding:50px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center}.container{background:white;padding:40px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.2);max-width:500px;width:90%}.loading{color:#666}.error{color:#d32f2f}.success{color:#388e3c}.spinner{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.btn{background:#667eea;color:white;padding:12px 24px;border:none;border-radius:6px;cursor:pointer;text-decoration:none;display:inline-block;margin-top:20px}.btn:hover{background:#5a6fd8}</style><script>function validate(){const urlParams=new URLSearchParams(window.location.search);const token=urlParams.get("token");const user=urlParams.get("user");const module=urlParams.get("module");if(!token||!user||!module){document.getElementById("status").innerHTML="<h1 class=\"error\">‚ùå Lien invalide</h1><p>Param√®tres manquants dans l\'URL</p><a href=\"http://metube:8081\" class=\"btn\">Acc√©der directement</a>";return}document.getElementById("status").innerHTML="<h1 class=\"success\">‚úÖ Acc√®s valid√© !</h1><p>Token: "+token.substring(0,16)+"...</p><p>User: "+user.substring(0,8)+"...</p><p>Module: "+module+"</p><p>Redirection en cours...</p>";setTimeout(()=>{window.location.href="http://metube:8081";},2000)}validate();</script></head><body><div class="container"><div id="status" class="loading"><h1>üîç Validation de votre acc√®s</h1><div class="spinner"></div><p>V√©rification de votre magic link...</p></div></div></body></html>';
    }

    # Redirection pour magic links vers la page de validation
    location / {
        # Si il y a des param√®tres de magic link, rediriger vers la page de validation
        if ($args ~ "token=") {
            return 302 /validate$is_args$args;
        }
        
        # Sinon, rediriger vers metube
        return 302 http://metube:8081$request_uri;
    }
} 